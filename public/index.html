<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de WhatsApp - Sucursales</title>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>ðŸ“ž Estado de WhatsApp por Sucursal</h1>
  <div style="position: absolute; top: 10px; right: 10px; display: flex; align-items: center; gap: 0.5rem;">
    <label for="toggle-mensajes" style="font-size: 1rem; font-weight: bold;">Mostrar Mensajes</label>
    <label class="switch">
      <input type="checkbox" id="toggle-mensajes">
      <span class="slider round"></span>
    </label>
  </div>
  <div id="botones-sucursales"></div>
  <div class="contenedor">
    <div id="sucursal-activa"></div>
    <div id="mensajes" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto;">
      <h3>Mensajes Recibidos:</h3>
    </div>
  </div>

  <script>
    const socket = io();
    const botonesDiv = document.getElementById('botones-sucursales');
    const sucursalActivaDiv = document.getElementById('sucursal-activa');
    const estados = {};
    const mensajesPorSucursal = {}; // Almacenar mensajes por sucursal
    let sucursalActiva = null;

    function renderBotones() {
      botonesDiv.innerHTML = '';

      for (const id in estados) {
        const data = estados[id];
        const boton = document.createElement('button');
        boton.className = 'boton-sucursal';
        if (id === sucursalActiva) {
          boton.classList.add('seleccionado');
        }
        boton.innerHTML = `
          <span class="icono ${data.status === 'conectado' ? 'conectado' : (data.status === 'escanea' ? 'escanea' : 'desconectado')}"></span>
          ${data.nombre}
        `;
        boton.onclick = () => {
          sucursalActiva = id;
          renderBotones();
          mostrarSucursal(id);
        };
        botonesDiv.appendChild(boton);
      }
    }

    function mostrarSucursal(id) {
      sucursalActiva = id;
      const data = estados[id];
      sucursalActivaDiv.innerHTML = `
        <div class="sucursal">
          <h2>${data.nombre}</h2>
          <p class="estado">Estado: <span style="color: ${data.status === 'conectado' ? 'green' : (data.status === 'escanea' ? 'orange' : 'red')}">
            ${data.status}
          </span></p>
          ${data.qr ? `<div class="qr"><img src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(data.qr)}&size=200x200" alt="QR de ${data.nombre}" /></div>` : ''}
        </div>
      `;

      mostrarMensajes(id); // Mostrar mensajes de la sucursal activa
    }

    function mostrarMensajes(sucursal) {
      const mensajesDiv = document.getElementById('mensajes');
      mensajesDiv.innerHTML = '<h3>Mensajes Recibidos:</h3>'; // Limpiar mensajes previos

      if (mensajesPorSucursal[sucursal]) {
        mensajesPorSucursal[sucursal].slice().reverse().forEach(({ mensaje, nombre, hora }) => {
          const nuevoMensaje = document.createElement('div');
          nuevoMensaje.style.display = 'flex';
          nuevoMensaje.style.justifyContent = 'space-between';
          nuevoMensaje.style.marginBottom = '5px';

          const textoMensaje = document.createElement('span');
          textoMensaje.textContent = `${nombre}: ${mensaje}`;

          const horaMensaje = document.createElement('span');
          horaMensaje.textContent = hora;
          horaMensaje.style.color = 'gray';
          horaMensaje.style.fontSize = '0.9em';

          nuevoMensaje.appendChild(textoMensaje);
          nuevoMensaje.appendChild(horaMensaje);
          mensajesDiv.appendChild(nuevoMensaje);
        });
      }
    }

    fetch('/config/sucursales.json')
      .then(res => res.json())
      .then(data => {
        data.forEach(sucursal => {
          estados[sucursal.id] = { nombre: sucursal.nombre, status: 'conectando', qr: null };
        });
        
        // Set the first branch as active by default
        if (data.length > 0) {
          sucursalActiva = data[0].id;
          mostrarSucursal(sucursalActiva);
        }

        renderBotones();
      });

    socket.on('estado', ({ sucursal, status }) => {
      if (estados[sucursal]) {
        estados[sucursal].status = status;
        estados[sucursal].qr = null;
        renderBotones();
        if (sucursal === sucursalActiva) mostrarSucursal(sucursal);
      }
    });

    socket.on('qr', ({ sucursal, qr }) => {
      if (estados[sucursal]) {
        estados[sucursal].status = 'escanea';
        estados[sucursal].qr = qr;
        renderBotones();
        if (sucursal === sucursalActiva) mostrarSucursal(sucursal);
      }
    });

    // Escuchar mensajes emitidos por el servidor
    socket.on('mensaje', ({ sucursal, mensaje, nombre, hora }) => {
      if (!mensajesPorSucursal[sucursal]) {
        mensajesPorSucursal[sucursal] = [];
      }
      mensajesPorSucursal[sucursal].push({ mensaje, nombre, hora });

      if (sucursal === sucursalActiva) {
        mostrarMensajes(sucursal);
      }
    });

    const toggleMensajes = document.getElementById('toggle-mensajes');
    const mensajesDiv = document.getElementById('mensajes');
    const contenedorDiv = document.querySelector('.contenedor');

    // Set default state to hidden
    mensajesDiv.style.display = 'none';
    contenedorDiv.classList.add('centrado'); // Center by default when messages are hidden

    toggleMensajes.addEventListener('change', () => {
      if (toggleMensajes.checked) {
        mensajesDiv.style.display = 'block';
        contenedorDiv.classList.remove('centrado'); // Reset centering when messages are shown
      } else {
        mensajesDiv.style.display = 'none';
        contenedorDiv.classList.add('centrado'); // Center when messages are hidden
      }
    });
  </script>
</body>
</html>
